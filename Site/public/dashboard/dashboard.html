<!DOCTYPE html>
<html lang="pt">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />

	<!-- Boxicons -->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" rel="stylesheet" />
	<!-- My CSS -->
	<link rel="stylesheet" href="dashboard.css" />
	<script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>
	<link href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css" rel="stylesheet" />
	<title>DataCat</title>
</head>
<script src="../js/Listar.js"></script>
<body
	onload='listarAlerta(),plotarGrafico("graficoMemoria"),plotarGrafico("graficoCpu"),plotarGrafico("graficoDisco"),plotarGrafico("graficoTemp"),validarSessao()'>
	<!-- SIDEBAR -->
	<section id="sidebar">
		<a href="#" class="brand">
			<img src="./img/kisspng-whiskers-black-cat-logo-computer-icons-holding-cat-5b2478eb76bcb4.4233985815291169074864.png"
				alt="" />
			<span class="text">DataCat</span>
		</a>
		<ul class="side-menu top">
			<li class="active">
				<a href="./dashboard.html">
					<span class="material-icons-sharp"> grid_view </span>
					<span class="text">Dashboard</span>
				</a>
			</li>
			<li>
				<a href="../cadastro-funcionario.html">
					<span class="material-icons-sharp"> perm_identity </span>
					<span class="text">Cadastrar usuário</span>
				</a>
			</li>

			<li>
				<a href="../cadastro-maquina.html">
					<span class="material-icons-sharp">add_to_queue</span>
					<span>Máquina</span>
				</a>
			</li>

		</ul>
		<ul class="side-menu">
			<li>
				<a href="../login.html" class="logout" onclick="limparSessao()">
					<span class="material-icons-sharp">logout</span>
					<span class="text">Sair</span>
				</a>
			</li>
		</ul>
	</section>
	<!-- SIDEBAR -->

	<!-- CONTENT -->
	<section id="content">
		<!-- NAVBAR -->
		<nav>
			<i class="bx bx-menu"></i>
			<!-- <span class="material-icons-sharp"> -->

			<form action="#">
					<select onchange="
					obterDadosGrafico(maquinas_select.value)
					" name="" id="maquinas_select" class="input">
						<option value="">Selecione uma Máquina</option>
					</select>
				
			</form>
			<input type="checkbox" id="switch-mode" hidden />
			<label for="switch-mode" class="switch-mode"></label>
			<a href="#" class="notification">
				<span class="material-icons-sharp"> notifications </span>
				<span class="num">8</span>
			</a>
			<a href="#" class="profile">
				<img src="img/larissa.jpeg" />
			</a>
		</nav>
		<!-- NAVBAR -->

		<!-- MAIN -->
		<main>
			<div class="head-title">
				<div class="left">
					<h1>Dashboard</h1>
					<ul class="breadcrumb">
						<li>
							<a href="#">Dashboard</a>
						</li>
						<li><i class="bx bx-chevron-right"></i></li>
						<li>
							<a class="active" href="#">Home</a>
						</li>
					</ul>
				</div>
		
			</div>

			<ul class="box-info">
				<li id="divRam">
					<span class="text">
						<div class="div-title">
							<div class="icon">
								<span class="material-icons-sharp"> memory</span>
							</div>
							<h3>Memória ram</h3>
						</div>
					</span>
					<div id="divGraficoRam">
						<canvas id="graficoMemoria"></canvas>
					</div>
				</li>
				<li>
					<span class="text">
						<div class="div-title">
							<span class="material-icons-sharp"> memory</span>
							<h3 class="cpuTitle">CPU</h3>
						</div>
					</span>
					<div id="divGraficoCpu">
						<canvas id="graficoCpu"></canvas>
					</div>
				</li>
				<li>
					<span class="text">
						<div class="div-title">
							<span class="material-icons-sharp"> memory</span>
							<h3>Disco rígido</h3>
						</div>
					</span>
					<div id="divGraficoDisco">
						<canvas id="graficoDisco"></canvas>
					</div>
				</li>
				<li>
					<span class="text">
						<div class="div-title">
							<span class="material-icons-sharp"> memory</span>
							<h3>Temperatura</h3>
						</div>
					</span>
					<div id="divGraficoTemp">
						<canvas id="graficoTemp"></canvas>
					</div>
				</li>
			</ul>

			<div class="table-data">
				<div class="order">
					<div class="head">
						<h3>Histórico de alertas</h3>
						<i class="bx bx-search"></i>
						<i class="bx bx-filter"></i>
					</div>

					<div id="listaAlerta"></div>
				</div>
				<div class="todo">
					<div class="head">
						<h3>Últimas operações</h3>
						<i class="bx bx-plus"></i>
						<i class="bx bx-filter"></i>
					</div>
					<ul class="todo-list">
						<p><b>Larissa Alves</b></p>
						<li class="completed">
							<img src="./img/larissa.jpeg" alt="" />
							<i class="bx bx-dots-vertical-rounded"></i>

							<small>Componente: <br />
								Memoria Ram</small>
							<small>Categoria: <br />
								<span>Urgente</span></small>
							<small>ID do alerta: <br />
								0120</small>
							<small>Há 30 minutos <br />
								atrás</small>
							<!--  Ultima opração</p>
								
									  <p>Categoria:<span>Urgente</span>
									</p>
									<p>ID do alerta: 0120</p> 
									
									<small>Há 30 minutos atrás</small> -->
						</li>
						<p><b>Guilherme Carneiro</b></p>
						<li class="completed">
							<img src="./img/gui.jpeg" alt="" />
							<i class="bx bx-dots-vertical-rounded"></i>

							<small>Componente: <br />
								Memoria Ram</small>
							<small>Categoria: <br />
								<span>Urgente</span></small>
							<small>ID do alerta: <br />
								0120</small>
							<small>Há 30 minutos <br />
								atrás</small>
						</li>
						<p><b>Leticia Marques</b></p>
						<li class="completed">
							<img src="./img/leticia.jpeg" alt="" />
							<i class="bx bx-dots-vertical-rounded"></i>

							<small>Componente: <br />
								Memoria Ram</small>
							<small>Categoria: <br />
								<span>Urgente</span></small>
							<small>ID do alerta: <br />
								0120</small>
							<small>Há 30 minutos <br />
								atrás</small>
						</li>
						<p><b>Vinicius Pieroni</b></p>
						<li class="completed">
							<img src="./img/vinicius.jpeg" alt="" />
							<i class="bx bx-dots-vertical-rounded"></i>

							<small>Componente: <br />
								Memoria Ram</small>
							<small>Categoria: <br />
								<span>Urgente</span></small>
							<small>ID do alerta: <br />
								0120</small>
							<small>Há 30 minutos <br />
								atrás</small>
						</li>
						<p><b>Lucas Mastelini</b></p>
						<li class="completed">
							<img src="./img/lucas.jpeg" alt="" />
							<i class="bx bx-dots-vertical-rounded"></i>

							<small>Componente: <br />
								Memoria Ram</small>
							<small>Categoria: <br />
								<span>Urgente</span></small>
							<small>ID do alerta: <br />
								0120</small>
							<small>Há 30 minutos <br />
								atrás</small>
						</li>
					</ul>
				</div>
			</div>
		</main>
		<!-- MAIN -->
	</section>
	<!-- CONTENT -->

	<!-- <script src="script.js"></script> -->
</body>

</html>

<script>
	fetch(`/maquinas/listar-todas/${sessionStorage.ID_EMPRESA}`, {
		method: "GET",
	}).then((response) => {
		if (response.ok) {
			response.json().then((json) => {
				console.log(json);
				for (let i = 0; i < json.length; i++) {
					maquinas_select.innerHTML += `<option value="${json[i].hostName}">${json[i].hostName}</option>`;
				}
			});
		}
	});
</script>

<script src="script.js">
	const allSideMenu = document.querySelectorAll('#sidebar .side-menu.top li a');

	allSideMenu.forEach(item => {
		const li = item.parentElement;

		item.addEventListener('click', function () {
			allSideMenu.forEach(i => {
				i.parentElement.classList.remove('active');
			})
		})
	});




	// TOGGLE SIDEBAR
	const menuBar = document.querySelector('#content nav .bx.bx-menu');
	const sidebar = document.getElementById('sidebar');

	menuBar.addEventListener('click', function () {
		sidebar.classList.toggle('hide');
	})







	const searchButton = document.querySelector('#content nav form .form-input button');
	const searchButtonIcon = document.querySelector('#content nav form .form-input button .bx');
	const searchForm = document.querySelector('#content nav form');

	searchButton.addEventListener('click', function (e) {
		if (window.innerWidth < 576) {
			e.preventDefault();
			searchForm.classList.toggle('show');
			if (searchForm.classList.contains('show')) {
				searchButtonIcon.classList.replace('bx-search', 'bx-x');
			} else {
				searchButtonIcon.classList.replace('bx-x', 'bx-search');
			}
		}
	})

	if (window.innerWidth < 768) {
		sidebar.classList.add('hide');
	} else if (window.innerWidth > 576) {
		searchButtonIcon.classList.replace('bx-x', 'bx-search');
		searchForm.classList.remove('show');
	}


	window.addEventListener('resize', function () {
		if (this.innerWidth > 576) {
			searchButtonIcon.classList.replace('bx-x', 'bx-search');
			searchForm.classList.remove('show');
		}
	})
</script>

<script>
	let proximaAtualizacao = [];

	verificar_autenticacao();

	// O gráfico é construído com três funções:
	// 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez
	// 2. plotarGrafico -> Monta o gráfico com os dados trazidos e exibe em tela
	// 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

	// Esta função *obterDadosGrafico* busca os últimos dados inseridos em tabela de medidas.
	// para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
	// A função *obterDadosGrafico* também invoca a função *plotarGrafico*

	//     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
	//     Para ajustar o "select", ajuste o comando sql em src/models

	function obterDadosGrafico(hostname) {
		// alterarTitulo(hostname);

		if (proximaAtualizacao != undefined) {
			for (let i = 0; i < proximaAtualizacao.length; i++) {
				const element = proximaAtualizacao[i];
				clearTimeout(element);
			}
		}

		fetch(`/medidas/ultimas/${hostname}`, { cache: "no-store" })
			.then(function (response) {
				if (response.ok) {
					response.json().then(function (resposta) {
						console.log(
							`[OBTER DADOS] Dados recebidos: ${JSON.stringify(resposta)}`
						);
						resposta.reverse();

						plotarGrafico(resposta, hostname);
					});
				} else {
					console.error("Nenhum dado encontrado ou erro na API");
				}
			})
			.catch(function (error) {
				console.error(
					`Erro na obtenção dos dados p/ gráfico: ${error.message}`
				);
			});
	}

	// Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
	// Configura o gráfico (cores, tipo, etc), materializa-o na página e,
	// A função *plotarGrafico* também invoca a função *atualizarGrafico*
	function plotarGrafico(resposta, hostname) {
		console.log("iniciando plotagem do gráfico...");

		var dadosDisco = {
			labels: [],
			datasets: [
				{
					yAxisID: "y-umidade",
					label: "Uso (em %)",
					backgroundColor: ["rgba(255, 99, 132, 0.12)"],
					borderColor: ["rgba(255, 99, 132, 1)"],
					fill: true,
					borderWidth: 1,
					data: [],
				},
			],
		};

		var dadosRam = {
			labels: [],
			datasets: [
				{
					yAxisID: "y-umidade",
					label: "Uso (em %)",
					backgroundColor: ["rgba(255, 99, 132, 0.12)"],
					borderColor: ["rgba(255, 99, 132, 1)"],
					fill: true,
					borderWidth: 1,
					data: [],
				},
			],
		};

		var dadosCpu = {
			labels: [],
			datasets: [
				{
					yAxisID: "y-umidade",
					label: "Uso (em %)",
					backgroundColor: ["rgba(255, 99, 132, 0.12)"],
					borderColor: ["rgba(255, 99, 132, 1)"],
					fill: true,
					borderWidth: 1,
					data: [],
				},
			],
		};

		var dadosTemp = {
			labels: [],
			datasets: [
				{
					yAxisID: "y-umidade",
					label: "Graus Celsius",
					backgroundColor: ["rgba(255, 99, 132, 0.12)"],
					borderColor: ["rgba(255, 99, 132, 1)"],
					fill: true,
					borderWidth: 1,
					data: [],
				},
			],
		};

		for (let i = 0; i < resposta.length; i++) {
			const e = resposta[i];
			switch (e.nome) {
				case "Disco":
					dadosDisco.labels.push(e.dataHora);
					dadosDisco.datasets[0].data.push(e.leituraDesempenho);
					break;

				case "Ram":
					dadosRam.labels.push(e.dataHora);
					dadosRam.datasets[0].data.push(e.leituraDesempenho);

					break;

				case "Cpu":
					dadosCpu.labels.push(e.dataHora);
					dadosCpu.datasets[0].data.push(e.leituraDesempenho);

					dadosTemp.labels.push(e.dataHora);
					dadosTemp.datasets[0].data.push(e.leituraTemperatura);

					break;

				default:
					break;
			}
		}

		var dadosArray = [dadosRam, dadosCpu, dadosDisco, dadosTemp];
		console.log("Dados do Disco: " + dadosArray[0]);
		console.log("Dados da Ram: " + dadosArray[1]);
		console.log("Dados da Cpu: " + dadosArray[2]);
		console.log("Dados da Temperatura: " + dadosArray[3]);

		var idGraficos = [
			"graficoMemoria",
			"graficoCpu",
			"graficoDisco",
			"graficoTemp",
		];

		var variaveisDeAmbiente = [
			"graficoRam",
			"graficoCpu",
			"graficoDisco",
			"graficoTemp",
		];

		var ctx = document.getElementById(idGraficos[0]).getContext("2d");
		window.graficoRam = Chart.Line(ctx, {
			data: dadosArray[0],
			options: {
				responsive: true,
				animation: { duration: 500 },
				hoverMode: "index",
				stacked: false,
				title: {
					display: false,
					text: "Dados capturados",
				},
				scales: {
					yAxes: [
						{
							type: "linear",
							display: true,
							position: "left",
							id: "y-temperatura",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},
						},
						{
							type: "linear",
							display: false,
							position: "right",
							id: "y-umidade",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},

							gridLines: {
								drawOnChartArea: false,
							},
						},
					],
				},
			},
		});

		var ctx = document.getElementById(idGraficos[1]).getContext("2d");
		window.graficoCpu = Chart.Line(ctx, {
			data: dadosArray[1],
			options: {
				responsive: true,
				animation: { duration: 500 },
				hoverMode: "index",
				stacked: false,
				title: {
					display: false,
					text: "Dados capturados",
				},
				scales: {
					yAxes: [
						{
							type: "linear",
							display: true,
							position: "left",
							id: "y-temperatura",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},
						},
						{
							type: "linear",
							display: false,
							position: "right",
							id: "y-umidade",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},

							gridLines: {
								drawOnChartArea: false,
							},
						},
					],
				},
			},
		});

		var ctx = document.getElementById(idGraficos[2]).getContext("2d");
		window.graficoDisco = Chart.Line(ctx, {
			data: dadosArray[2],
			options: {
				responsive: true,
				animation: { duration: 500 },
				hoverMode: "index",
				stacked: false,
				title: {
					display: false,
					text: "Dados capturados",
				},
				scales: {
					yAxes: [
						{
							type: "linear",
							display: true,
							position: "left",
							id: "y-temperatura",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},
						},
						{
							type: "linear",
							display: false,
							position: "right",
							id: "y-umidade",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},

							gridLines: {
								drawOnChartArea: false,
							},
						},
					],
				},
			},
		});

		var ctx = document.getElementById(idGraficos[3]).getContext("2d");
		window.graficoTemp = Chart.Line(ctx, {
			data: dadosArray[3],
			options: {
				responsive: true,
				animation: { duration: 500 },
				hoverMode: "index",
				stacked: false,
				title: {
					display: false,
					text: "Dados capturados",
				},
				scales: {
					yAxes: [
						{
							type: "linear",
							display: true,
							position: "left",
							id: "y-temperatura",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},
						},
						{
							type: "linear",
							display: false,
							position: "right",
							id: "y-umidade",
							ticks: {
								beginAtZero: true,
								max: 100,
								min: 0,
							},

							gridLines: {
								drawOnChartArea: false,
							},
						},
					],
				},
			},
		});

		console.log("CONTEUDO DE DADOS: ");
		console.log(dadosArray);

		setTimeout(() => atualizarGrafico(hostname, dadosArray), 2000);

	}



	// Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
	// buscando a última medida inserida em tabela contendo as capturas,

	//     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
	//     Para ajustar o "select", ajuste o comando sql em src/models
	function atualizarGrafico(hostname, dados) {
		fetch(`/medidas/tempo-real/${hostname}`, { cache: "no-store" })
			.then(function (response) {
				if (response.ok) {
					response.json().then(function (novoRegistro) {
						console.log(
							`[ATUALIZAR GRAFICO] Dados recebidos: ${JSON.stringify(
								novoRegistro
							)}`
						);
						console.log(
							`[ATUALIZAR GRAFICO] Dados atuais do gráfico: ${dados[0].datasets[0].data}`
						);

						//RAM
						// tirando e colocando valores no gráfico
						if (novoRegistro[1].nome == "Ram") {
							dados[0].labels.shift(); // apagar o primeiro
							dados[0].labels.push(novoRegistro[1].dataHora); // incluir um novo momento

							dados[0].datasets[0].data.shift(); // apagar o primeiro de temperatura
							dados[0].datasets[0].data.push(novoRegistro[1].leituraDesempenho); // incluir uma nova medida de temperatura
						}

						//CPU
						// tirando e colocando valores no gráfico
						if (novoRegistro[0].nome == "Cpu") {
							dados[1].labels.shift(); // apagar o primeiro
							dados[1].labels.push(novoRegistro[0].dataHora); // incluir um novo momento

							dados[1].datasets[0].data.shift(); // apagar o primeiro de temperatura
							dados[1].datasets[0].data.push(novoRegistro[0].leituraDesempenho); // incluir uma nova medida de temperatura

							//TEMPERATURA
							// tirando e colocando valores no gráfico
							dados[3].labels.shift(); // apagar o primeiro
							dados[3].labels.push(novoRegistro[0].dataHora); // incluir um novo momento

							dados[3].datasets[0].data.shift(); // apagar o primeiro de temperatura
							dados[3].datasets[0].data.push(novoRegistro[0].leituraTemperatura); // incluir uma nova medida de temperatura
						}

						//DISCO
						// tirando e colocando valores no gráfico
						if (novoRegistro[2].nome == "Disco") {
							dados[2].labels.shift(); // apagar o primeiro
							dados[2].labels.push(novoRegistro[2].dataHora); // incluir um novo momento

							dados[2].datasets[0].data.shift(); // apagar o primeiro de temperatura
							dados[2].datasets[0].data.push(novoRegistro[2].leituraDesempenho); // incluir uma nova medida de temperatura
						}




						if (novoRegistro[1].leituraTemperatura == null) {
							console.log('TEMPERATURA NULA, POR ISSO O GRÁFICO NÃO MEXE');
						}

						console.log(novoRegistro[1].leituraTemperatura);

						window.graficoRam.update();
						window.graficoCpu.update();
						window.graficoDisco.update();
						window.graficoTemp.update();

						// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
						proximaAtualizacao.push(
							setTimeout(() => atualizarGrafico(hostname, dados), 2000)
						);
					});
				} else {
					console.error("Nenhum dado encontrado ou erro na API");
					// Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
					proximaAtualizacao.push(
						setTimeout(() => atualizarGrafico(hostname, dados), 2000)
					);
				}
			})
			.catch(function (error) {
				console.error(
					`Erro na obtenção dos dados p/ gráfico: ${error.message}`
				);
			});
	}
</script>